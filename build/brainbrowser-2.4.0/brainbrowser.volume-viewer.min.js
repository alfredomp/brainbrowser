/*
* BrainBrowser: Web-based Neurological Visualization Tools
* (https://brainbrowser.cbrain.mcgill.ca)
*
* Copyright (C) 2011
* The Royal Institution for the Advancement of Learning
* McGill University
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as
* published by the Free Software Foundation, either version 3 of the
* License, or (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
* BrainBrowser v2.4.0
*
* Author: Tarek Sherif  <tsherif@gmail.com> (http://tareksherif.ca/)
* Author: Nicolas Kassis
* Author: Paul Mougel
*
* three.js (c) 2010-2014 three.js authors, used under the MIT license
*/
!function(){"use strict";function a(a){var b=!1,c=!1,d=!1,e=!1,f=document.createElement("canvas"),g=null;b=!!f,c=!!window.Worker;try{f&&window.WebGLRenderingContext&&(g=f.getContext("webgl")||f.getContext("experimental-webgl")),d=!!g}catch(h){d=!1}d&&(e=!!g.getExtension("OES_element_index_uint")),a.CANVAS_ENABLED=b,a.WEB_WORKERS_ENABLED=c,a.WEBGL_ENABLED=d,a.WEBGL_UINT_INDEX_ENABLED=e}var b="2.4.0";b=b.indexOf("BRAINBROWSER_VERSION")>0?"D.E.V":b;var c=window.BrainBrowser={version:b};a(c),window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||function(a){window.clearTimeout(a)}}(),function(){"use strict";function a(b,c,d,e){return c>d?e(b):void Object.keys(b).forEach(function(f){a(b[f],c+1,d,e)})}BrainBrowser.createTreeStore=function(){var b={};return{set:function(){var a,c,d,e,f=arguments[arguments.length-1],g=Array.prototype.slice.call(arguments,0,arguments.length-1),h=b;for(c=0,d=g.length-1;d>c;c++){if(a=g[c],h[a]&&"object"!=typeof h[a])throw e="Hash key '["+g.slice(0,c+1).join("][")+"]' has already been set to a non-object value.\nCannot set '["+g.join("][")+"]'",BrainBrowser.events.triggerEvent("error",{message:e}),new Error(e);h[a]||(h[a]={}),h=h[a]}a=g[c],h[a]=f},get:function(){var a,c,d,e=Array.prototype.slice.call(arguments),f=b;if(0===e.length)return b;for(c=0,d=e.length-1;d>c;c++){if(a=e[c],void 0===f[a])return null;f=f[a]}return a=e[c],void 0!==f[a]?f[a]:null},remove:function(){var a,c,d,e,f=Array.prototype.slice.call(arguments),g=b;for(c=0,d=f.length-1;d>c;c++){if(a=f[c],void 0===g[a])return null;g=g[a]}return a=f[c],e=g[a],g[a]=void 0,e},reset:function(a){a=a&&"object"==typeof a?a:{},b=a},forEach:function(c,d){c=c>0?c:1,a(b,1,c,d)}}}}(),function(){"use strict";BrainBrowser.createColorMap=function(a,b){function c(a,b,c,d,e,f,g){var h;return(b>a||a>c)&&!e?-1:(h=Math.floor(Math.max(0,Math.min((a-b)*d,g-1))),f&&(h=g-1-h),h*=4)}function d(a,b,c){var d,e,f,g=document.createElement("canvas"),h=new Array(256);for(g.width=256,g.height=c,d=0;256>d;d++)h[d]=d;for(f=u.scale,u.scale=255,a=u.mapColors(h),u.scale=f,e=g.getContext("2d"),d=0;256>d;d++)e.fillStyle="rgb("+Math.floor(a[4*d])+", "+Math.floor(a[4*d+1])+", "+Math.floor(a[4*d+2])+")",e.fillRect(d,0,1,b);return g}b=b||{};var e,f,g,h,i,j,k,l,m=void 0===b.clamp?!0:b.clamp,n=b.flip||!1,o=b.scale||1,p=b.contrast||1,q=b.brightness||0;if(a)if(b.freesurfer){f=a.trim().split(/\n/),e={};var r=function(a){return""!==a};for(i=0;i<f.length;i++){var s=f[i];if("#"!==s[0]){var t=s.split(" ");t=t.filter(r),6===t.length&&(t[2]=parseInt(t[2],10),t[3]=parseInt(t[3],10),t[4]=parseInt(t[4],10),t[5]=parseInt(t[5],10),e[t[0]]=[t[1],t[2],t[3],t[4],t[5]])}}}else for(f=a.trim().split(/\n/),e=new Float32Array(4*f.length),k=0,i=0,g=f.length;g>i;i++)if(l=f[i].trim().split(/\s+/).slice(0,4),h=l.length,!(3>h)){for(j=0;h>j;j++)e[k+j]=parseFloat(l[j]);4>h&&(e[k+3]=1),k+=4}var u={colors:e,clamp:m,flip:n,scale:o,contrast:p,brightness:q,freesurfer:b.freesurfer,mapColors:function(a,b){b=b||{};var d,e,f,g,h=void 0===b.min?0:b.min,i=void 0===b.max?255:b.max,j=b.default_colors||[0,0,0,1],k=b.destination||new Float32Array(4*a.length),l=u.colors;if(u.freesurfer){for(d=0;d<a.length;d++){n=a[d],e=4*d;var m=l[n];m?(k[e]=m[1],k[e+1]=m[2],k[e+2]=m[3],k[e+3]=m[4]):(k[e]=0,k[e+1]=0,k[e+2]=0,k[e+3]=0)}return k}var n,o,p=u.colors.length/4,q=void 0===b.scale?u.scale:b.scale,r=void 0===b.clamp?u.clamp:b.clamp,s=void 0===b.flip?u.flip:b.flip,t=void 0===b.brightness?u.brightness:b.brightness,v=void 0===b.contrast?u.contrast:b.contrast,w=4===j.length?0:1,x=i-h,y=p/x;for(t*=q,v*=q,d=0,g=a.length;g>d;d++)n=a[d],e=4*d,o=c(n,h,i,y,r,s,p),0>o?(f=e*w,k[e]=v*j[f]+t,k[e+1]=v*j[f+1]+t,k[e+2]=v*j[f+2]+t,k[e+3]=q*j[f+3]):(k[e]=v*l[o]+t,k[e+1]=v*l[o+1]+t,k[e+2]=v*l[o+2]+t,k[e+3]=q*l[o+3]);return k},colorFromValue:function(a,b){b=b||{};var d=b.hex||!1,e=void 0===b.min?0:b.min,f=void 0===b.max?255:b.max,g=void 0===b.scale?u.scale:b.scale,h=void 0===b.brightness?u.brightness:b.brightness,i=void 0===b.contrast?u.contrast:b.contrast,j=f-e;if(u.freesurfer){var k=u.colors[a];return k?[k[1],k[2],k[3],k[4]]:[0,0,0,0]}var l,m=u.colors.length/4,n=m/j,o=c(a,e,f,n,u.clamp,u.flip,m);return l=o>=0?Array.prototype.slice.call(u.colors,o,o+4):[0,0,0,1],l[0]=Math.max(0,Math.min(i*l[0]+h,1)),l[1]=Math.max(0,Math.min(i*l[1]+h,1)),l[2]=Math.max(0,Math.min(i*l[2]+h,1)),d?(l[0]=Math.floor(255*l[0]),l[1]=Math.floor(255*l[1]),l[2]=Math.floor(255*l[2]),l[3]=Math.floor(255*l[3]),l[0]=("0"+l[0].toString(16)).slice(-2),l[1]=("0"+l[1].toString(16)).slice(-2),l[2]=("0"+l[2].toString(16)).slice(-2),l=l.slice(0,3).join("")):(l[0]=l[0]*g,l[1]=l[1]*g,l[2]=l[2]*g,l[3]=l[3]*g),l},createElement:function(a,b){var c,e,f=u.colors,g=b-a;return c=d(f,20,40,n),e=c.getContext("2d"),e.fillStyle="#FFA000",e.fillRect(.5,20,1,10),e.fillText(a.toPrecision(3),.5,40),e.fillRect(c.width/4,20,1,10),e.fillText((a+.25*g).toPrecision(3),.25*c.width,40),e.fillRect(c.width/2,20,1,10),e.fillText((a+.5*g).toPrecision(3),.5*c.width,40),e.fillRect(3*c.width/4,20,1,10),e.fillText((a+.75*g).toPrecision(3),.75*c.width,40),e.fillRect(c.width-.5,20,1,10),e.fillText(b.toPrecision(3),c.width-20,40),c}};return u}}(),function(){"use strict";var a=BrainBrowser.createTreeStore();BrainBrowser.config={set:function(b,c){b=b||"";var d=b.split(".");d.push(c),a.set.apply(a,d)},get:function(b){b=b||"";var c=b.split(".");return a.get.apply(a,c)}}}(),function(){"use strict";function a(a,b){try{a.call(b.target,b)}catch(c){console.error("Error in event handler for: ",b.name),console.error(c.stack||c.message||c)}}var b=["eventmodelcleanup"];BrainBrowser.events={unpropagatedEvent:function(a){b.push(a)},addEventModel:function(c){var d=[],e={};c.addEventListener=function(a,b){d[a]||(d[a]=[]),d[a].push(b)},c.triggerEvent=function(e,f){var g=this,h=c.directPropagationTargets(e);f=f||{},f.name=e,f.target=g,d[e]&&d[e].forEach(function(b){a(b,f)}),d["*"]&&d["*"].forEach(function(b){a(b,f)}),-1===b.indexOf(e)&&(h.forEach(function(a){a.triggerEvent.call(g,e,f)}),0===h.length&&c!==BrainBrowser.events&&BrainBrowser.events.triggerEvent.call(g,e,f))},c.propagateEventTo=function(a,b){if(!BrainBrowser.utils.isFunction(b.allPropagationTargets))throw new Error("Propagation target doesn't seem to have an event model.");if(c===BrainBrowser.events||-1!==b.allPropagationTargets(a).indexOf(c))throw new Error("Propagating event '"+a+"' would cause a cycle.");e[a]=e[a]||[],-1===c.directPropagationTargets().indexOf(b)&&b.addEventListener("eventmodelcleanup",function(){this===b&&c.stopPropagatingTo(b)}),-1===e[a].indexOf(b)&&e[a].push(b)},c.propagateEventFrom=function(a,b){b.propagateEventTo(a,c)},c.stopPropagatingTo=function(a){Object.keys(e).forEach(function(b){e[b]=e[b].filter(function(b){return b!==a})})},c.directPropagationTargets=function(a){var b=[],c=void 0===a?Object.keys(e):[a,"*"];return c.forEach(function(a){var c=e[a]||[];c.forEach(function(a){-1===b.indexOf(a)&&b.push(a)})}),b},c.allPropagationTargets=function(a){var b=c.directPropagationTargets(a),d=Array.prototype.slice.call(b);return b.forEach(function(b){b.allPropagationTargets(a).forEach(function(a){-1===d.indexOf(a)&&d.push(a)})}),d}}},BrainBrowser.events.addEventModel(BrainBrowser.events)}(),function(){"use strict";var a=BrainBrowser.loader={loadFromURL:function(b,c,d){d=d||{};var e,f=new XMLHttpRequest,g=d.result_type,h=b.split("/"),i=h[h.length-1];f.open("GET",b),"arraybuffer"===g&&(f.responseType="arraybuffer"),f.onreadystatechange=function(){if(4===f.readyState){if(e=f.status,!(e>=200&&300>e||304===e)){var g="error loading URL: "+b+"\nHTTP Response: "+f.status+"\nHTTP Status: "+f.statusText+"\nResponse was: \n"+f.response;throw BrainBrowser.events.triggerEvent("error",{message:g}),new Error(g)}a.checkCancel(d)||c(f.response,i,d)}},f.send()},loadFromFile:function(a,b,c){var d=a.files;if(0!==d.length){c=c||{};var e=c.result_type,f=new FileReader,g=a.value.split("\\"),h=g[g.length-1];f.file=d[0],f.onloadend=function(a){b(a.target.result,h,c)},f.onerror=function(){var a="error reading file: "+h;throw BrainBrowser.events.triggerEvent("error",{message:a}),new Error(a)},"arraybuffer"===e?f.readAsArrayBuffer(d[0]):f.readAsText(d[0])}},loadColorMapFromURL:function(b,c,d){a.loadFromURL(b,function(a,b,d){c(BrainBrowser.createColorMap(a,d),b,d)},d)},loadColorMapFromFile:function(b,c,d){a.loadFromFile(b,function(a,b,d){c(BrainBrowser.createColorMap(a,d),b,d)},d)},checkCancel:function(a){a=a||{},BrainBrowser.utils.isFunction(a)&&(a={test:a});var b=a.test,c=a.cleanup,d=!1;return b&&b()&&(d=!0,c&&c()),d}}}(),function(){"use strict";BrainBrowser.utils={webglExtensionAvailable:function(a){if(!BrainBrowser.WEBGL_ENABLED)return!1;var b=document.createElement("canvas"),c=b.getContext("webgl")||b.getContext("experimental-webgl");return!!c.getExtension(a)},webGLErrorMessage:function(){var a,b='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';return b+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>",b+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.',a=document.createElement("div"),a.id="webgl-error",a.innerHTML=b,a},isFunction:function(a){return a instanceof Function||"function"==typeof a},isNumeric:function(a){return!isNaN(parseFloat(a))},createDataURL:function(a,b){if(!window.URL||!window.URL.createObjectURL)throw new Error("createDataURL requires URL.createObjectURL which does not seem to be available is this browser.");return window.URL.createObjectURL(new Blob([a],{type:b||"text/plain"}))},min:function(){var a=Array.prototype.slice.call(arguments);a=1===a.length&&BrainBrowser.utils.isNumeric(a[0].length)?a[0]:a;var b,c,d=a[0];for(b=1,c=a.length;c>b;b++)a[b]<d&&(d=a[b]);return d},max:function(){var a=Array.prototype.slice.call(arguments);a=1===a.length&&BrainBrowser.utils.isNumeric(a[0].length)?a[0]:a;var b,c,d=a[0];for(b=1,c=a.length;c>b;b++)a[b]>d&&(d=a[b]);return d},getOffset:function(a){for(var b=0,c=0;a.offsetParent;)b+=a.offsetTop,c+=a.offsetLeft,a=a.offsetParent;return{top:b,left:c}},captureMouse:function(a){var b={x:0,y:0,left:!1,middle:!1,right:!1};return a.addEventListener("mousemove",function(c){var d=a.getBoundingClientRect();b.x=c.x-d.left,b.y=c.y-d.top},!1),a.addEventListener("mousedown",function(a){a.preventDefault(),0===a.button&&(b.left=!0),1===a.button&&(b.middle=!0),2===a.button&&(b.right=!0)},!1),a.addEventListener("mouseup",function(a){a.preventDefault(),0===a.button&&(b.left=!1),1===a.button&&(b.middle=!1),2===a.button&&(b.right=!1)},!1),a.addEventListener("mouseleave",function(a){a.preventDefault(),b.left=b.middle=b.right=!1},!1),a.addEventListener("contextmenu",function(a){a.preventDefault()},!1),b},captureTouch:function(a){function b(b){var d,e,f,g,h,i=BrainBrowser.utils.getOffset(a);for(c.length=g=b.touches.length,f=0;g>f;f++)h=b.touches[f],void 0!==h.pageX?(d=h.pageX,e=h.pageY):(d=h.clientX+window.pageXOffset,e=h.clientY+window.pageYOffset),c[f]=c[f]||{},c[f].x=d-i.left,c[f].y=e-i.top}var c=[];return a.addEventListener("touchstart",b,!1),a.addEventListener("touchmove",b,!1),a.addEventListener("touchend",b,!1),c}}}(),function(){"use strict";var a=BrainBrowser.VolumeViewer={};a.modules={},a.volume_loaders={},a.start=function(b,c){function d(){document.addEventListener("keydown",function(a){if(f.active_panel){var b,c,d,e=f.active_panel,g=e.volume,h=e.axis,i=a.which,j={};return j=1===f.interaction_type?{37:function(){g.position[h]>0&&(g.position[h]--,g.position_continuous[h]--)},38:function(){g.position[h]<g.header[h].space_length&&(g.position[h]++,g.position_continuous[h]++)},39:function(){g.position[h]<g.header[h].space_length&&(g.position[h]++,g.position_continuous[h]++)},40:function(){g.position[h]>0&&(g.position[h]--,g.position_continuous[h]--)}}:{17:function(){e.anchor||(e.mouse.left||e.mouse.middle||e.mouse.right)&&(e.anchor={x:e.mouse.x,y:e.mouse.y})},37:function(){b=e.slice.width_space.name,g.position[b]>0&&g.position[b]--},38:function(){b=e.slice.height_space.name,g.position[b]<e.slice.height_space.space_length&&g.position[b]++},39:function(){b=e.slice.width_space.name,g.position[b]<e.slice.width_space.space_length&&g.position[b]++},40:function(){b=e.slice.height_space.name,g.position[b]>0&&g.position[b]--}},"function"==typeof j[i]?(a.preventDefault(),j[i](),f.redrawVolumes(),f.synced&&(d=e.getVoxelCoordinates(),f.volumes.forEach(function(a){var b;a!==g&&(Object.keys(g.position).forEach(function(b){a.position[b]=g.position[b]}),a.display.forEach(function(a){a!==b&&a.updateSlice()}))})),!1):32===i&&(a.preventDefault(),g.header.time)?(c=a.shiftKey?Math.max(0,g.current_time-1):Math.min(g.current_time+1,g.header.time.space_length-1),g.current_time=c,f.synced&&f.volumes.forEach(function(a){a!==g&&(a.current_time=Math.max(0,Math.min(c,a.header.time.space_length-1)))}),f.redrawVolumes(),!1):void 0}},!1),document.addEventListener("keyup",function(a){var b=a.which,c={17:function(){f.volumes.forEach(function(a){a.display.forEach(function(a){a.anchor=null})})}};return"function"==typeof c[b]?(a.preventDefault(),c[b](),!1):void 0},!1)}var e;e="string"==typeof b?document.getElementById(b):b;var f={dom_element:e,volumes:[],synced:!1,interaction_type:0};return Object.keys(a.modules).forEach(function(b){a.modules[b](f)}),BrainBrowser.events.addEventModel(f),console.log("BrainBrowser Volume Viewer v"+BrainBrowser.version),d(),c(f),f}}(),function(){"use strict";BrainBrowser.VolumeViewer.createDisplay=function(){var a={},b={setPanel:function(c,d){a[c]&&a[c].triggerEvent("eventmodelcleanup"),d.propagateEventTo("*",b),a[c]=d},getPanel:function(b){return a[b]},refreshPanels:function(){b.forEach(function(a){a.updateSlice()})},setContrast:function(a){b.forEach(function(b){b.contrast=a})},setBrightness:function(a){b.forEach(function(b){b.brightness=a})},forEach:function(b){Object.keys(a).forEach(function(c,d){b(a[c],c,d)})}};return BrainBrowser.events.addEventModel(b),b.addEventListener("eventmodelcleanup",function(){b.forEach(function(a){a.triggerEvent("eventmodelcleanup")})}),b}}(),function(){"use strict";function a(a,b){a.slice=b}function b(a,b,c,d){var e,f,g,h,i,j,k,l,m=d,n=a.zoom,o=a.cursor_size,p=a.image_translate;b=b||"#FF0000",e=c?c:a.getCursorPosition(),m.save(),m.strokeStyle=b,m.fillStyle=b,f=e.x,g=e.y,m.beginPath(),m.lineWidth=.5,i=a.slice.width_space.step,j=a.slice.height_space.step,k=f-i*o,l=g-j*o,i+=2*i*o,j+=2*j*o,m.moveTo(k,l),m.lineTo(k+i,l),m.lineTo(k+i,l+j),m.lineTo(k,l+j),m.lineTo(k,l),m.stroke(),m.globalAlpha=.5,m.closePath(),a.anchor&&(i=a.anchor.x-e.x,j=a.anchor.y-e.y,h=Math.sqrt(i*i+j*j),m.save(),m.setTransform(1,0,0,1,0,0),f=f/n+p.x,g=g/n+p.y,m.fillText(h.toFixed(2),f,g),m.restore(),m.lineWidth=1,m.beginPath(),m.arc(a.anchor.x,a.anchor.y,1,0,2*Math.PI),m.fill(),m.moveTo(a.anchor.x,a.anchor.y),m.lineTo(e.x,e.y),m.stroke()),m.restore()}function c(a){var b=a.slice,c=b.width_space.start,d=b.height_space.start;return{x:c,y:d}}BrainBrowser.VolumeViewer.createPanel=function(d){d=d||{};var e=0,f={x:0,y:0},g={x:0,y:0},h=null,i=[],j={image_translate:{x:0,y:0},zoom:1,contrast:1,brightness:0,updated:!0,draw_cursor:!0,cursor_size:0,view_description:d.view_description,smooth_image:!0,setSize:function(a,b,c){if(c=c||{},a=a>0?a:0,b=b>0?b:0,j.canvas_layers)for(var d=0;d<j.canvas_layers.length;d++){var e=j.canvas_layers[d].canvas;e.width=a,e.height=b}j.canvas=j.canvas_layers[j.canvas_layers.length-1].canvas,c.scale_image&&(j.image_translate.x=j.canvas.width/2,j.image_translate.y=j.canvas.height/2,j.zoom=Math.min(j.canvas.width/(j.slice.width_space.space_length*j.slice.width_space.step),j.canvas.height/(j.slice.height_space.space_length*j.slice.height_space.step))),j.updated=!0},followPointer:function(a){var b=a.x-g.x,c=a.y-g.y;return g.x=a.x,g.y=a.y,{dx:b,dy:c}},translateImage:function(a,b){j.image_translate.x+=a,j.image_translate.y+=b,j.updated=!0},reset:function(){j.zoom=1,j.image_translate.x=j.canvas.width/2,j.image_translate.y=j.canvas.height/2,j.updated=!0},getCursorPosition:function(a,b){var d=j.volume,e=j.slice,f=c(j),g=d.position[e.width_space.name],h=d.position[e.height_space.name];return a&&(g=a),b&&(h=b),{x:g*Math.abs(e.width_space.step)+f.x,y:h*Math.abs(e.height_space.step)+f.y}},updateVolumePosition:function(a,b){var c=j.volume,d=j.getVolumePosition(a,b);d&&(c.position[j.slice.width_space.name]=Math.floor(d.slice_x),c.position[j.slice.height_space.name]=Math.floor(d.slice_y),c.position_continuous[j.slice.width_space.name]=d.slice_x,c.position_continuous[j.slice.height_space.name]=d.slice_y,j.updated=!0)},getVolumePosition:function(a,b){var d,e,f,g,h,i=c(j),k=j.slice;return(void 0===a||void 0===b)&&(d=j.getCursorPosition(),a=d.x,b=d.y),a=(a-j.transformation_matrix[4])/j.transformation_matrix[0],b=(b-j.transformation_matrix[5])/j.transformation_matrix[3],g=Math.abs(k.width_space.step),h=Math.abs(k.height_space.step),e=(a-i.x)/g,f=(b-i.y)/h,0>e||e>k.width_space.space_length||0>f||f>k.height_space.space_length?null:{slice_x:e,slice_y:f}},getVoxelCoordinates:function(){return{i:j.volume.position[j.volume.header.order[0]],j:j.volume.position[j.volume.header.order[1]],k:j.volume.position[j.volume.header.order[2]]}},updateSlice:function(a){clearTimeout(h),BrainBrowser.utils.isFunction(a)&&i.push(a),h=setTimeout(function(){var a=j.volume,b=j.slice;j.triggerEvent("sliceupdate",{volume:a,slice:b}),j.updated=!0,i.forEach(function(a){a(b)}),i.length=0},0)},draw:function(a,b){var d=j.getCursorPosition();if((f.x!==d.x||f.y!==d.y)&&(f.x=d.x,f.y=d.y,j.updated=!0,j.triggerEvent("cursorupdate",{volume:j.volume,cursor:d})),e!==j.zoom&&(e=j.zoom,j.updated=!0,j.triggerEvent("zoom",{volume:j.volume,zoom:j.zoom})),j.touches[0]?(g.x=j.touches[0].x,g.y=j.touches[0].y):(g.x=j.mouse.x,g.y=j.mouse.y),j.updated){var h,i,k=j.volume.header[j.axis],l=j.image_translate.x+(k.width_space.start+Math.abs(k.width_space.space_length*k.width_space.step/2))*j.zoom,m=j.image_translate.y+(k.height_space.start+Math.abs(k.height_space.space_length*k.height_space.step/2))*j.zoom;j.transformation_matrix=[-j.zoom,0,0,-j.zoom,l,m];var n,o={tm:j.transformation_matrix,width:j.slice.width_space.space_length,width_spacing:Math.abs(j.slice.width_space.step),height:j.slice.height_space.space_length,height_spacing:Math.abs(j.slice.height_space.step),origin:c(j),axis:j.axis,cursor_color:a,cursor:d};for(n=0;n<j.canvas_layers.length;n++)h=j.canvas_layers[n],i=h.canvas.getContext("2d"),i.imageSmoothingEnabled=j.smooth_image,i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,h.canvas.width,h.canvas.height),i.restore(),h.draw(h.canvas_buffer,i,o);if(h=j.canvas_layers[0],i=h.canvas.getContext("2d"),j.triggerEvent("draw",{volume:j.volume,cursor:d,canvas:h,context:i}),b){h=j.canvas_layers[j.canvas_layers.length-1],i=h.canvas.getContext("2d");var p=4,q=p/2;i.save(),i.setTransform(1,0,0,1,0,0),i.strokeStyle="#EC2121",i.lineWidth=p,i.strokeRect(q,q,i.canvas.width-p,i.canvas.height-p),i.restore()}j.updated=!1}},drawVolumeSlice:function(a,b,c,d){var e=j.volume;j.slice=e.slice(j.axis),c.setTransform(d.tm[0],d.tm[1],d.tm[2],d.tm[3],d.tm[4],d.tm[5]);var f,g;if(e.volumes?(f=j.slice.slice(a,j.axis),g=e.getSliceImage(a,f,j.contrast,j.brightness),c.globalAlpha=e.blend_ratios[a]):(f=j.slice,g=e.getSliceImage(f,j.zoom,j.contrast,j.brightness)),g){var h=f.width_space.space_length*f.width_space.step,i=f.height_space.space_length*f.height_space.step,k=b.getContext("2d"),l={};l.x=f.width_space.start,l.y=f.height_space.start,k.putImageData(g,0,0),c.imageSmoothingEnabled=j.smooth_image,c.drawImage(b,l.x,l.y,h,i)}},drawMousePointer:function(a,b){var c=j.canvas_layers[j.canvas_layers.length-1].canvas,d=c.getContext("2d"),e={tm:j.transformation_matrix,cursor_color:a,cursor_coords:b};d.imageSmoothingEnabled=!1,d.save(),d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,c.width,c.height),d.restore(),j.drawCursorLayer(void 0,d,e)},setDrawCursor:function(a){j.draw_cursor=a},setCursorSize:function(a){j.cursor_size=a,j.updated=!0},drawCursorLayer:function(a,c,d){var e=d.tm;if(c.setTransform(e[0],e[1],e[2],e[3],e[4],e[5]),j.view_description){c.save(),c.setTransform(1,0,0,1,0,0);for(var f=0;f<j.view_description.length;f++){var g=j.view_description[f];c.fillStyle="rgba(255,255,255,1)",c.fillText(g.text,g.x*c.canvas.width,g.y*c.canvas.height)}c.restore()}b(j,d.cursor_color,d.cursor_coords,c)}};return Object.keys(d).forEach(function(a){BrainBrowser.utils.isFunction(j[a])||(j[a]=d[a])}),j.volume&&a(j,j.volume.slice(j.axis)),j}}(),function(){"use strict";BrainBrowser.VolumeViewer.utils={nearestNeighbor:function(a,b,c,d,e,f){f=f||{};var g,h,i,j,k,l,m,n,o,p,q=f.block_size||1,r=f.array_type||Uint8ClampedArray;if(b===d&&c===e)return a;for(k=new r(d*e*q),g=b/d,h=c/e,m=0;e>m;m++)for(i=Math.floor(m*h)*b,n=m*d,l=0;d>l;l++)for(j=(i+Math.floor(l*g))*q,o=(n+l)*q,p=0;q>p;p++)k[o+p]=a[j+p];return k},bilinear:function(a,b,c,d,e,f){f=f||{};var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=f.block_size||1,B=f.array_type||Uint8ClampedArray;if(b===d&&c===e)return a;for(q=new B(d*e*A),g=b/d,h=c/e,s=0;e>s;s++)for(m=s*h,o=Math.floor(m),t=s*d,r=0;d>r;r++)for(n=r*g,p=Math.floor(n),i=(o*b+p)*A,j=(o*b+p+1)*A,k=((o+1)*b+p)*A,l=((o+1)*b+p+1)*A,w=(p+1-n)*(o+1-m),x=(n-p)*(o+1-m),y=(p+1-n)*(m-o),z=(n-p)*(m-o),u=(t+r)*A,v=0;A>v;v++)q[u+v]=w*a[i+v]+x*a[j+v]+y*a[k+v]+z*a[l+v];return q},flipArray:function(a,b,c,d){d=d||{};var e,f,g,h,i,j,k,l,m,n=d.flipx||!1,o=d.flipy||!1,p=d.block_size||1,q=new a.constructor(a.length);if(!n&&!o){for(e=0,f=a.length;f>e;e++)q[e]=a[e];return q}for(f=0;c>f;f++)for(j=f*b,i=o?c-f-1:f,l=i*b,e=0;b>e;e++)for(k=(j+e)*p,h=n?b-e-1:e,m=(l+h)*p,g=0;p>g;g++)q[k+g]=a[m+g];return q}}}(),BrainBrowser.VolumeViewer.modules.loading=function(a){"use strict";function b(a,b){var c,d=i.volume_loaders[a.type];if(!d)throw c="Unsuported Volume Type",BrainBrowser.events.triggerEvent("error",{message:c}),new Error(c);d(a,b)}function c(c,d,e){b(d,function(b){var f=0,g=d.views||["xspace","yspace","zspace"];BrainBrowser.events.addEventModel(b),b.addEventListener("eventmodelcleanup",function(){b.display.triggerEvent("eventmodelcleanup")}),a.volumes[c]=b,b.color_map=j,b.display=h(a.dom_element,c,d),b.propagateEventTo("*",a),b.display.forEach(function(c){c.updateSlice(function(){++f===g.length&&(a.triggerEvent("volumeloaded",{volume:b}),BrainBrowser.utils.isFunction(e)&&e(b))})})})}function d(b,c,d){b.cursor_color=c,j=b,a.volumes.forEach(function(a){a.color_map=a.color_map||j}),BrainBrowser.utils.isFunction(d)&&d(b)}function e(b,c,d,e){c.cursor_color=d,a.setVolumeColorMap(b,c),BrainBrowser.utils.isFunction(e)&&e(a.volumes[b],c)}function f(a,b,c,d){var e=document.getElementById(c).innerHTML.replace(/\{\{VOLID\}\}/gm,b),f=document.createElement("div");f.innerHTML=e;var g,h,i,j=f.childNodes,k=f.getElementsByClassName(d)[0];for(g=0,h=a.childNodes.length;h>g;g++)i=a.childNodes[g],1===i.nodeType&&(k.appendChild(i),g--,h--);return j}function g(a,b,c,d,e){var f={},g=document.createElement("canvas");if(g.id=a,g.width=b,g.height=c,g.style.backgroundColor="transparent",g.style.position="absolute",g.top=5,g.left=5,g.style["z-index"]=d,f.canvas=g,e){var h=document.createElement("canvas");h.width=e.width,h.height=e.height,f.canvas_buffer=h}return f}function h(b,c,d){var e=document.createElement("div");if(void 0!==d.id?b.id==="brainbrowser-"+d.id&&b.appendChild(e):b.appendChild(e),d.style){var h=document.createAttribute("style");h.value=d.style,e.setAttributeNode(h)}var j,m=a.volumes[c],n=i.createDisplay(),o=d.template||{},p=d.views||["xspace","yspace","zspace"];return n.propagateEventTo("*",m),e.className="volume-container",p.forEach(function(a){var b=document.createElement("div");b.id="div_"+a+"_vol"+c,b.style.position="relative",b.style.height=l+10+"px",b.style.width=k+10+"px",e.appendChild(b);var f={width:m.header[a].width,height:m.header[a].height},h=[],j=[m],o=1;m.volumes&&(o=m.volumes.length,j=m.volumes);var p,q;for(p=0;o>p;p++)f={width:j[p].header[a].width,height:j[p].header[a].height},q=g("canvas_"+a+"_vol"+c,k,l,p,f),0===p&&(q.canvas.style.backgroundColor="#000000"),h.push(q);var r;if(d.views_description&&d.views_description[a]&&(r=d.views_description[a]),d.canvas_layers)for(p=0;p<d.canvas_layers.length;p++)q=g("canvas_layer_"+a+"_vol"+c,k,l,h.length,f),q.draw=d.canvas_layers[p].draw,h.push(q);var s=i.createPanel({volume:m,volume_id:c,axis:a,canvas_div:b,view_description:r,canvas_layers:h,canvas:h[h.length-1].canvas,image_translate:{x:k/2,y:l/2}}),t=function(a,b,c){s.drawVolumeSlice(this.current_vol_id,a,b,c)};for(p=0;o>p;p++){var u={current_vol_id:p};h[p].draw=t.bind(u)}var v=g("canvas_layer_"+s.axis+"_cursor",k,l,h.length);for(v.draw=s.drawCursorLayer,h.push(v),p=0;p<h.length;p++)b.appendChild(h[p].canvas);BrainBrowser.events.addEventModel(s),s.mouse=BrainBrowser.utils.captureMouse(v.canvas),s.touches=BrainBrowser.utils.captureTouch(v.canvas),n.setPanel(a,s)}),o.element_id&&o.viewer_insert_class&&(j=f(e,c,o.element_id,o.viewer_insert_class),"function"==typeof o.complete&&o.complete(m,j),Array.prototype.forEach.call(j,function(a){1===a.nodeType&&e.appendChild(a)})),function(){var b=null;p.forEach(function(d){function e(b,c,e){e&&(1===a.interaction_type||(a.volumes.forEach(function(a){a.display.forEach(function(a){a.anchor=null})}),r.anchor=r.getCursorPosition())),c||(r.updateVolumePosition(b.x,b.y),m.display.forEach(function(a){r!==a&&a.updateSlice()}),a.synced&&a.syncPosition(r,m,d)),r.updated=!0}function f(b,e,f){var g;e?(g=r.followPointer(b),r.translateImage(g.dx,g.dy),a.synced&&a.volumes.forEach(function(a,b){var e;b!==c&&(e=a.display.getPanel(d),e.translateImage(g.dx,g.dy))})):f&&1===a.interaction_type?(g=r.followPointer(b),g.dx>0&&r.contrast<2?r.contrast+=.05:g.dx<0&&r.contrast>0&&(r.contrast-=.05),r.contrast>2&&(r.contrast=2),r.contrast<0&&(r.contrast=0),g.dy>0&&r.brightness>-1?r.brightness-=.05:g.dy<0&&r.brightness<1&&(r.brightness+=.05),r.brightness>1&&(r.brightness=1),r.brightness<-1&&(r.brightness=-1),r.updateSlice()):(r.updateVolumePosition(b.x,b.y),m.display.forEach(function(a){r!==a&&a.updateSlice()}),a.synced&&a.syncPosition(r,m,d)),r.updated=!0}function g(a){a.target===b&&(a.preventDefault(),f(r.mouse,a.shiftKey,a.ctrlKey))}function h(a){a.target===b&&(a.preventDefault(),f(r.touches[0],r.touches.length===p.length,a.ctrlKey))}function i(){document.removeEventListener("mousemove",g,!1),document.removeEventListener("mouseup",i,!1),a.volumes.forEach(function(a){a.display.forEach(function(a){a.anchor=null})}),b=null}function j(){document.removeEventListener("touchmove",h,!1),document.removeEventListener("touchend",j,!1),a.volumes.forEach(function(a){a.display.forEach(function(a){a.anchor=null})}),b=null}function k(a){var b,c=r.touches[0].x-r.touches[1].x,d=r.touches[0].y-r.touches[1].y,e=Math.sqrt(c*c+d*d);a.preventDefault(),null!==t&&(b=e-t,q(.2*b)),t=e}function l(){document.removeEventListener("touchmove",k,!1),document.removeEventListener("touchend",l,!1),t=null}function o(a){a.preventDefault(),q(Math.max(-1,Math.min(1,a.wheelDelta||-a.detail)))}function q(b){r.zoom=Math.max(r.zoom+.05*b,.05),r.updateSlice(),a.synced&&a.volumes.forEach(function(a,b){var e=a.display.getPanel(d);b!==c&&(e.zoom=r.zoom,e.updateVolumePosition(),e.updateSlice())})}var r=n.getPanel(d),s=r.canvas;r.canvas_layers&&r.canvas_layers.length>0&&(s=r.canvas_layers[r.canvas_layers.length-1].canvas);var t=null;s.addEventListener("mousedown",function(c){c.preventDefault(),b=c.target,a.active_panel&&(a.active_panel.updated=!0),a.active_panel=r,document.addEventListener("mousemove",g,!1),document.addEventListener("mouseup",i,!1),e(r.mouse,c.shiftKey,c.ctrlKey)},!1),s.addEventListener("touchstart",function(c){c.preventDefault(),b=c.target,a.active_panel&&(a.active_panel.updated=!0),a.active_panel=r,2===r.touches.length?(document.removeEventListener("touchmove",h,!1),document.removeEventListener("touchend",j,!1),document.addEventListener("touchmove",k,!1),document.addEventListener("touchend",l,!1)):(document.removeEventListener("touchmove",k,!1),document.removeEventListener("touchend",l,!1),document.addEventListener("touchmove",h,!1),document.addEventListener("touchend",j,!1),e(r.touches[0],3===r.touches.length,!0))},!1),s.addEventListener("mousewheel",o,!1),s.addEventListener("DOMMouseScroll",o,!1)})}(),b.appendChild(e),a.triggerEvent("volumeuiloaded",{container:e,volume:m,volume_id:c}),n}var i=BrainBrowser.VolumeViewer,j=null,k=256,l=256;a.loadVolumes=function(b){function d(d){c(d,g[d],function(){++j<h||(b.overlay&&h>1?a.createOverlay(f,function(){BrainBrowser.utils.isFunction(i)&&i(),a.triggerEvent("volumesloaded")}):(BrainBrowser.utils.isFunction(i)&&i(),a.triggerEvent("volumesloaded")))})}b=b||{};var e,f=b.overlay&&"object"==typeof b.overlay?b.overlay:{},g=b.volumes,h=b.volumes.length,i=b.complete,j=0;for(e=0;h>e;e++)d(e)},a.loadVolumeColorMapFromURL=function(a,b,c,d){var f={scale:255};-1!==b.indexOf("FreeSurfer")&&(f.freesurfer=!0),BrainBrowser.loader.loadColorMapFromURL(b,function(b){e(a,b,c,d)},f)},a.loadDefaultColorMapFromURL=function(a,b,c){BrainBrowser.loader.loadColorMapFromURL(a,function(a){d(a,b,c)},{scale:255})},a.loadVolumeColorMapFromFile=function(a,b,c,d){BrainBrowser.loader.loadColorMapFromFile(b,function(b){e(a,b,c,d)},{scale:255})},a.loadDefaultColorMapFromFile=function(a,b,c){BrainBrowser.loader.loadColorMapFromFile(a,function(a){d(a,b,c)},{scale:255})},a.setVolumeColorMap=function(b,c){a.volumes[b].color_map=c},a.loadVolume=function(b,d){c(a.volumes.length,b,d)},a.clearVolumes=function(){a.volumes.forEach(function(a){a.triggerEvent("eventmodelcleanup")}),a.volumes=[],a.active_panel=null,a.dom_element.innerHTML=""},a.createOverlay=function(b,c){b=b||{},a.loadVolume({volumes:a.volumes,type:"overlayVolumes",template:b.template,views:b.views||["xspace","yspace","zspace"],views_description:b.views_description,canvas_layers:b.canvas_layers,style:b.style,id:b.id},c)},a.setDefaultPanelSize=function(a,b){k=a,l=b},a.syncPosition=function(b,c,d){var e=c.getWorldCoords();a.volumes.forEach(function(a){if(a!==c){var b=a.display.getPanel(d);b.volume.setWorldCoords(e.x,e.y,e.z),b.updated=!0,a.display.forEach(function(a){a!==b&&a.updateSlice()})}})}},BrainBrowser.VolumeViewer.modules.rendering=function(a){"use strict";a.draw=function(){a.volumes.forEach(function(b){b.display.forEach(function(c){c.draw(b.color_map.cursor_color,a.active_panel===c)})})},a.render=function(){a.triggerEvent("rendering"),function b(){window.requestAnimationFrame(b),a.draw()}()},a.redrawVolume=function(b){var c=a.volumes[b];c.display.forEach(function(a){a.updateSlice()})},a.redrawVolumes=function(){a.volumes.forEach(function(b,c){a.redrawVolume(c)})},a.resetDisplays=function(){a.volumes.forEach(function(a){a.display.forEach(function(a){a.reset()})})},a.setPanelSize=function(b,c,d){a.volumes.forEach(function(a){a.display.forEach(function(a){a.setSize(b,c,d)})})},a.setViewerPosition=function(b){var c={xspace:Math.floor(b.xspace),yspace:Math.floor(b.yspace),zspace:Math.floor(b.zspace)};a.volumes.forEach(function(a){a.position=c,a.position_continuous=b,a.display.forEach(function(a){a.updateSlice()})}),a.redrawVolumes()}},function(){"use strict";function a(a,b){var c={order:["xspace","yspace","zspace"],xspace:{},yspace:{},zspace:{}};c.xspace.name="xspace",c.yspace.name="yspace",c.zspace.name="zspace";var d=Module.HEAP32.subarray(a.GetDimensions(),a.GetDimensions()+3);c.xspace.space_length=d[0],c.yspace.space_length=d[1],c.zspace.space_length=d[2];var e=Module.HEAPF64.subarray(a.GetSpacing(),a.GetSpacing()+3);c.xspace.step=e[0],c.yspace.step=e[1],c.zspace.step=e[2];var f=Module.HEAPF64.subarray(a.GetOrigin(),a.GetOrigin()+3);c.xspace.start=f[0],c.yspace.start=f[1],c.zspace.start=f[2];var g=Module.HEAPF64.subarray(a.GetDirection(),a.GetDirection()+9);c.xspace.direction_cosines=[g[0],g[1],g[2]],c.yspace.direction_cosines=[g[3],g[4],g[5]],c.zspace.direction_cosines=[g[6],g[7],g[8]],4===c.order.length&&(c.order=c.order.slice(1)),c.voxel_origin={x:c.xspace.start,y:c.yspace.start,z:c.zspace.start},c.xspace.width_space=c.yspace,c.xspace.width=c.yspace.space_length,c.xspace.height_space=c.zspace,c.xspace.height=c.zspace.space_length,c.yspace.width_space=c.xspace,c.yspace.width=c.xspace.space_length,c.yspace.height_space=c.zspace,c.yspace.height=c.zspace.space_length,c.zspace.width_space=c.xspace,c.zspace.width=c.xspace.space_length,c.zspace.height_space=c.yspace,c.zspace.height=c.yspace.space_length,BrainBrowser.utils.isFunction(b)&&b(c)
}function b(a,b,e){for(var g=d(a),h=Number.MAX_VALUE,i=-Number.MAX_VALUE,j=0;j<g.length;j++)h=Math.min(g[j],h),i=Math.max(g[j],i);var k={},l={};b.order.forEach(function(a){var c=b[a].space_length/2;k[a]=Math.floor(c),l[a]=c});var m={position:k,position_continuous:l,current_time:0,data:g,header:b,intensity_min:h,intensity_max:i,slice_image:{},slice_data:{},itk_image_j_s:a,slice:function(a,d){var e=b[a],f=e.width_space,g=e.height_space;void 0===d?d=m.position[a]:0>d?d=0:d>=e.space_length&&(d=e.space_length-1);var h=e.width,i=e.height,j={axis:a,width_space:f,height_space:g,width:h,height:i},k=m.itk_image_j_s.GetSlice(a,d);return j.data=c(m.itk_image_j_s.GetDataType(),k,h*i),m.border&&(j=m.getSliceBorder(j)),j},getVoxelMin:function(){return h},getVoxelMax:function(){return i},getSliceBorder:function(a){for(var b=new a.data.constructor(a.data),c=[-a.width-1,-a.width,-a.width+1,-1,1,a.width-1,a.width,a.width+1],d=function(a,b){for(var d=!1,e=a.data[b],f=0;f<c.length&&!d;f++){var g=b+c[f];if(g>=0&&g<a.data.length&&a.data[g]!==e){d=!0;break}}return d},e=0;e<a.data.length;e++)d(a,e)||(b[e]=0);return a.data=b,a},getSliceImage:function(a,b,c,d){if(a){var e=m.color_map;void 0===m.slice_image[a.axis]&&(m.slice_image[a.axis]=f.createImageData(a.width,a.height));var g=m.slice_image[a.axis];return e&&e.mapColors(a.data,{min:m.intensity_min,max:m.intensity_max,contrast:c,brightness:d,destination:g.data}),g}return null},getIntensityValue:function(a,c,d){var e=m.position;return void 0===a&&(a=e.xspace),void 0===c&&(c=e.yspace),void 0===d&&(d=e.zspace),a>=0&&a<=b.xspace.space_length&&c>=0&&c<=b.yspace.space_length&&d>=0&&d<=b.zspace.space_length?m.itk_image_j_s.GetPixel(a,c,d):null},setIntensityValue:function(a,b,c,d){m.itk_image_j_s.SetPixel(a,b,c,d)},getVoxelCoords:function(){var a=m.position;return{i:a.xspace,j:a.yspace,k:a.zspace}},setVoxelCoords:function(a,b,c){m.position.xspace=a,m.position.yspace=b,m.position.zspace=c},getWorldCoords:function(){var a=m.position.xspace,b=m.position.yspace,c=m.position.zspace,d=m.itk_image_j_s.TransformIndexToPhysicalPoint(a,b,c),e=Module.HEAP32.subarray(d,d+3);return{x:e[0],y:e[1],z:e[2]}},setWorldCoords:function(a,b,c){var d=m.worldToVoxel(a,b,c);m.setVoxelCoords(d.i,d.j,d.k)},voxelToWorld:function(a,b,c){var d=m.itk_image_j_s.TransformIndexToPhysicalPoint(a,b,c),e=Module.HEAPF64.subarray(d,d+3);return{i:e[0],j:e[1],k:e[2]}},worldToVoxel:function(a,b,c){var d=m.itk_image_j_s.TransformPhysicalPointToIndex(a,b,c),e=Module.HEAPF64.subarray(d,d+3);return{i:e[0],j:e[1],k:e[2]}}};BrainBrowser.utils.isFunction(e)&&e(m)}function c(a,b,c){var d=null;switch(a){case 2:d=Module.HEAPU8.subarray(b,b+c);break;case 4:d=Module.HEAP16.subarray(b,b+c);break;case 8:d=Module.HEAP32.subarray(b,b+c);break;case 16:d=Module.HEAPF32.subarray(b,b+c);break;case 32:d=Module.HEAPF64.subarray(b,b+c);break;case 256:d=Module.HEAP8.subarray(b,b+c);break;case 512:d=Module.HEAPU16.subarray(b,b+c);break;case 768:d=Module.HEAPU32.subarray(b,b+c);break;default:var e="Unsupported data type: "+a;throw BrainBrowser.events.triggerEvent("error",{message:e}),new Error(e)}return d}function d(a){var b=a.GetBufferPointer(),d=a.GetBufferSize(),e=c(a.GetDataType(),b,d);return e}var e=BrainBrowser.VolumeViewer,f=document.createElement("canvas").getContext("2d");e.volume_loaders.itkReaderURLMap={},e.volume_loaders.itkReader=function(c,d){var f;if(!c.url)throw f="invalid volume description.\nDescription must contain the property 'url'",BrainBrowser.events.triggerEvent("error",{message:f}),new Error(f);BrainBrowser.loader.loadFromURL(c.url,function(f){var g="/raw";try{FS.stat(g)}catch(h){FS.mkdir(g)}if(void 0===e.volume_loaders.itkReaderURLMap[c.url]){var i=c.url;i=i.substr(i.lastIndexOf("/")+1),i.lastIndexOf("?")>0&&(i=i.substr(0,i.indexOf("?"))),e.volume_loaders.itkReaderURLMap[c.url]=g+"/"+Date.now()+"_"+i}var j=e.volume_loaders.itkReaderURLMap[c.url];FS.writeFile(j,new Uint8Array(f),{encoding:"binary"});var k=new Module.itkImageJS;k.SetFilename(j),k.ReadImage(),a(k,function(a){b(k,a,d)})},{result_type:"arraybuffer"})}}(),function(){"use strict";function a(a,b){var c,f={order:["xspace","yspace","zspace"],xspace:{},yspace:{},zspace:{}},g=new DataView(a,0,284),h=!0,i=g.getUint32(0,!0);1===i?h=!0:16777216===i?h=!1:c="This does not look like an MGH file.";var j=0,k=[0,0,0,0],l=4,m=1;for(j=0;4>j&&(k[j]=g.getUint32(l,h),!(k[j]<=1));j++)m*=k[j],l+=4;(3>j||j>4)&&(c="Cannot handle "+j+"-dimensional images yet.");var n,o,p=g.getUint32(20,h),q=g.getUint16(28,h),r=[1,1,1],s=[[-1,0,0],[0,0,-1],[0,1,0],[0,0,0]];if(q){for(l=30,n=0;3>n;n++)r[n]=g.getFloat32(l,h),l+=4;for(n=0;4>n;n++)for(o=0;3>o;o++)s[n][o]=g.getFloat32(l,h),l+=4}if(e)for(n=0;3>n;n++){var t="";for(o=0;4>o;o++)t+="xyzc"[o]+"_"+"ras"[n]+" "+s[o][n]+" ";console.log(t)}for(var u=[0,1,2],v=0;3>v;v++){var w=0,x=Math.abs(s[v][0]),y=Math.abs(s[v][1]),z=Math.abs(s[v][2]);f.order[v]="xspace",y>x&&y>z&&(w=1,f.order[v]="yspace"),z>x&&z>y&&(w=2,f.order[v]="zspace"),u[v]=w}4===j&&(e&&console.log("Creating time dimension: "+k[3]),f.time={space_length:k[3],step:1,start:0,name:"time"},f.order.push("time"));var A=!1,B=[[0,0,0,0],[0,0,0,0],[0,0,0,0]];for(n=0;3>n;n++)for(o=0;3>o;o++)B[n][o]=s[o][n]*r[n];for(n=0;3>n;n++){var C=0;for(o=0;3>o;o++)C+=B[n][o]*(k[o]/2);B[n][3]=A?-C:s[3][n]-C}var D=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];for(n=0;3>n;n++)for(o=0;4>o;o++){var E=o;3>o&&(E=u[o]),D[n][E]=B[n][o]}if(d.utils.transformToMinc(D,f),void 0!==c)throw BrainBrowser.events.triggerEvent("error",{message:c}),new Error(c);for(f.datatype=p,f.little_endian=h,f.nvoxels=m,n=0;3>n;n++)f[f.order[n]].space_length=k[n];BrainBrowser.utils.isFunction(b)&&b(f)}function b(a,b,e){var f=d.createVolume(a,c(a,b));f.type="mgh",f.intensity_min=a.voxel_min,f.intensity_max=a.voxel_max,f.saveOriginAndTransform(a),BrainBrowser.utils.isFunction(e)&&e(f)}function c(a,b){var c=null,e=1;switch(a.datatype){case 0:e=1;break;case 1:case 3:e=4;break;case 4:e=2;break;default:var f="Unsupported data type: "+a.datatype;throw BrainBrowser.events.triggerEvent("error",{message:f}),new Error(f)}var g=a.nvoxels*e;switch(e>1&&!a.little_endian&&d.utils.swapn(new Uint8Array(b,284,g),e),a.datatype){case 0:c=new Uint8Array(b,284,a.nvoxels);break;case 1:c=new Int32Array(b,284,a.nvoxels);break;case 3:c=new Float32Array(b,284,a.nvoxels);break;case 4:c=new Int16Array(b,284,a.nvoxels)}d.utils.scanDataRange(c,a);var h,i=1;for(h=0;h<a.order.length;h++)a[a.order[h]].offset=i,i*=a[a.order[h]].space_length;return c}var d=BrainBrowser.VolumeViewer,e=!1;d.volume_loaders.mgh=function(c,d){var e;if(c.url)BrainBrowser.loader.loadFromURL(c.url,function(c){a(c,function(a){b(a,c,d)})},{result_type:"arraybuffer"});else{if(!c.file)throw e="invalid volume description.\nDescription must contain the property 'url' or 'file'.",BrainBrowser.events.triggerEvent("error",{message:e}),new Error(e);BrainBrowser.loader.loadFromFile(c.file,function(c){a(c,function(a){b(a,c,d)})},{result_type:"arraybuffer"})}}}(),function(){"use strict";function a(a,b){var c=null;switch(a.datatype){case"int8":c=new Int8Array(b);break;case"int16":c=new Int16Array(b);break;case"int32":c=new Int32Array(b);break;case"float32":c=new Float32Array(b);break;case"float64":c=new Float64Array(b);break;case"uint8":c=new Uint8Array(b);break;case"uint16":c=new Uint16Array(b);break;case"uint32":c=new Uint32Array(b);break;default:var d="Unsupported data type: "+a.datatype;throw BrainBrowser.events.triggerEvent("error",{message:d}),new Error(d)}return e.utils.scanDataRange(c,a),c}function b(b,c,d){var f=e.createVolume(b,a(b,c));f.type="minc",f.saveOriginAndTransform(b),f.intensity_min=b.voxel_min,f.intensity_max=b.voxel_max,BrainBrowser.utils.isFunction(d)&&d(f)}function c(a){a.xspace.name="xspace",a.yspace.name="yspace",a.zspace.name="zspace",a.xspace.width_space=a.yspace,a.xspace.width=a.yspace.space_length,a.xspace.height_space=a.zspace,a.xspace.height=a.zspace.space_length,a.yspace.width_space=a.xspace,a.yspace.width=a.xspace.space_length,a.yspace.height_space=a.zspace,a.yspace.height=a.zspace.space_length,a.zspace.width_space=a.xspace,a.zspace.width=a.xspace.space_length,a.zspace.height_space=a.yspace,a.zspace.height=a.yspace.space_length,void 0===a.voxel_min&&(a.voxel_min=0),void 0===a.voxel_max&&(a.voxel_max=255)}function d(a,b){var c,d;try{c=JSON.parse(a)}catch(e){throw d="server did not respond with valid JSON\nResponse was: \n"+a,BrainBrowser.events.triggerEvent("error",{message:d}),new Error(d)}4===c.order.length&&(c.order=c.order.slice(1)),c.datatype=c.datatype||"uint8",c.xspace.space_length=parseFloat(c.xspace.space_length),c.yspace.space_length=parseFloat(c.yspace.space_length),c.zspace.space_length=parseFloat(c.zspace.space_length),c.xspace.start=parseFloat(c.xspace.start),c.yspace.start=parseFloat(c.yspace.start),c.zspace.start=parseFloat(c.zspace.start),c.xspace.step=parseFloat(c.xspace.step),c.yspace.step=parseFloat(c.yspace.step),c.zspace.step=parseFloat(c.zspace.step),c.xspace.direction_cosines=c.xspace.direction_cosines||[1,0,0],c.yspace.direction_cosines=c.yspace.direction_cosines||[0,1,0],c.zspace.direction_cosines=c.zspace.direction_cosines||[0,0,1],c.xspace.direction_cosines=c.xspace.direction_cosines.map(parseFloat),c.yspace.direction_cosines=c.yspace.direction_cosines.map(parseFloat),c.zspace.direction_cosines=c.zspace.direction_cosines.map(parseFloat),c[c.order[0]].offset=c[c.order[1]].space_length*c[c.order[2]].space_length,c[c.order[1]].offset=c[c.order[2]].space_length,c[c.order[2]].offset=1,c.time&&(c.time.space_length=parseFloat(c.time.space_length),c.time.start=parseFloat(c.time.start),c.time.step=parseFloat(c.time.step),c.time.offset=c.xspace.space_length*c.yspace.space_length*c.zspace.space_length),BrainBrowser.utils.isFunction(b)&&b(c)}var e=BrainBrowser.VolumeViewer;e.volume_loaders.minc=function(a,c){var e;if(a.header_url&&a.raw_data_url)BrainBrowser.loader.loadFromURL(a.header_url,function(e){d(e,function(d){BrainBrowser.loader.loadFromURL(a.raw_data_url,function(a){b(d,a,c)},{result_type:"arraybuffer"})})});else{if(!a.header_file||!a.raw_data_file)throw e="invalid volume description.\nDescription must contain property pair 'header_url' and 'raw_data_url', or\n'header_file' and 'raw_data_file'.",BrainBrowser.events.triggerEvent("error",{message:e}),new Error(e);BrainBrowser.loader.loadFromFile(a.header_file,function(e){d(e,function(d){BrainBrowser.loader.loadFromFile(a.raw_data_file,function(a){b(d,a,c)},{result_type:"arraybuffer"})})})}},e.createVolume=function(a,b){var d=document.createElement("canvas").getContext("2d"),f={};c(a);var g={position:{},current_time:0,data:b,header:a,intensity_min:0,intensity_max:255,slice:function(a,b,c){b=void 0===b?g.position[a]:b,c=void 0===c?g.current_time:c;var d=g.header;if(void 0===d.order)return null;if(c=c||0,f[a]=f[a]||[],f[a][c]=f[a][c]||[],void 0!==f[a][c][b])return f[a][c][b];var e,h,i,j,k,l,m,n,o,p=d.time?c*d.time.offset:0,q=d[a],r=q.width_space,s=q.height_space,t=q.width,u=q.height,v=q.offset,w=r.offset,x=s.offset,y=new g.data.constructor(t*u),z=r.step>0,A=s.step>0,B=q.step>0,C=0;if(l=B?b:q.space_length-b-1,l>=0&&l<q.space_length)for(m=p+l*v,h=u-1;h>=0;h--)for(k=A?h:u-h-1,n=m+k*x,i=0;t>i;i++)j=z?i:t-i-1,o=n+j*w,y[C++]=g.data[o];return e={axis:a,data:y,width_space:r,height_space:s,width:t,height:u},f[a][c][b]=e,e},saveOriginAndTransform:function(a){var b=a.xspace.start,c=a.yspace.start,d=a.zspace.start,e=a.xspace.direction_cosines,f=a.yspace.direction_cosines,g=a.zspace.direction_cosines,h=a.xspace.step,i=a.yspace.step,j=a.zspace.step;a.voxel_origin={x:b*e[0]+c*f[0]+d*g[0],y:b*e[1]+c*f[1]+d*g[1],z:b*e[2]+c*f[2]+d*g[2]};var k=a.voxel_origin,l=(-k.x*e[0]-k.y*e[1]-k.z*e[2])/h,m=(-k.x*f[0]-k.y*f[1]-k.z*f[2])/i,n=(-k.x*g[0]-k.y*g[1]-k.z*g[2])/j;a.w2v=[[e[0]/h,e[1]/h,e[2]/h,l],[f[0]/i,f[1]/i,f[2]/i,m],[g[0]/j,g[1]/j,g[2]/j,n]]},getSliceImage:function(a,b,c,f){b=b||1;var h,i=g.color_map;if(!i)throw h="No color map set for this volume. Cannot render slice.",g.triggerEvent("error",h),new Error(h);var j=a.width_space.step,k=a.height_space.step,l=Math.abs(Math.floor(a.width*j*b)),m=Math.abs(Math.floor(a.height*k*b)),n=d.createImageData(a.width,a.height),o=d.createImageData(l,m);return i.mapColors(a.data,{min:g.intensity_min,max:g.intensity_max,contrast:c,brightness:f,destination:n.data}),o.data.set(e.utils.nearestNeighbor(n.data,n.width,n.height,l,m,{block_size:4})),o},getIntensityValue:function(a,b,c,d){var e=g.header,f=g.getVoxelCoords();if(a=void 0===a?f.i:a,b=void 0===b?f.j:b,c=void 0===c?f.k:c,d=void 0===d?g.current_time:d,0>a||a>=e[e.order[0]].space_length||0>b||b>=e[e.order[1]].space_length||0>c||c>=e[e.order[2]].space_length)return 0;var h=e.time?d*e.time.offset:0,i=a*e[e.order[0]].offset+b*e[e.order[1]].offset+c*e[e.order[2]].offset+h;return g.data[i]},getVoxelCoords:function(){var a=g.header,b={xspace:a.xspace.step>0?g.position.xspace:a.xspace.space_length-g.position.xspace,yspace:a.yspace.step>0?g.position.yspace:a.yspace.space_length-g.position.yspace,zspace:a.zspace.step>0?g.position.zspace:a.zspace.space_length-g.position.zspace};return{i:b[a.order[0]],j:b[a.order[1]],k:b[a.order[2]]}},setVoxelCoords:function(a,b,c){var d=g.header,e=d.order[0],f=d.order[1],h=d.order[2];g.position[e]=d[e].step>0?a:d[e].space_length-a,g.position[f]=d[f].step>0?b:d[f].space_length-b,g.position[h]=d[h].step>0?c:d[h].space_length-c},getWorldCoords:function(){var a=g.getVoxelCoords();return g.voxelToWorld(a.xspace,a.yspace,a.zspace)},setWorldCoords:function(a,b,c){var d=g.worldToVoxel(a,b,c);g.setVoxelCoords(d.i,d.j,d.k)},voxelToWorld:function(a,b,c){var d,e,f,h={},i=g.header;h[i.order[0]]=a,h[i.order[1]]=b,h[i.order[2]]=c,d=h.xspace,e=h.yspace,f=h.zspace;var j=i.xspace.direction_cosines,k=i.yspace.direction_cosines,l=i.zspace.direction_cosines,m=i.xspace.step,n=i.yspace.step,o=i.zspace.step,p=i.voxel_origin;return{x:d*j[0]*m+e*k[0]*n+f*l[0]*o+p.x,y:d*j[1]*m+e*k[1]*n+f*l[1]*o+p.y,z:d*j[2]*m+e*k[2]*n+f*l[2]*o+p.z}},worldToVoxel:function(b,c,d){var e=a.w2v,f={vx:b*e[0][0]+c*e[0][1]+d*e[0][2]+e[0][3],vy:b*e[1][0]+c*e[1][1]+d*e[1][2]+e[1][3],vz:b*e[2][0]+c*e[2][1]+d*e[2][2]+e[2][3]},g={};return g[a.order[0]]=Math.round(f.vx),g[a.order[1]]=Math.round(f.vy),g[a.order[2]]=Math.round(f.vz),{i:g.xspace,j:g.yspace,k:g.zspace}},getVoxelMin:function(){return g.header.voxel_min},getVoxelMax:function(){return g.header.voxel_max}};return g},e.utils.scanDataRange=function(a,b){var c=0,d=+1/0,e=-1/0;for(c=0;c<a.length;c++){var f=a[c];f>e&&(e=f),d>f&&(d=f)}b.voxel_min=d,b.voxel_max=e}}(),function(){"use strict";function a(a,c){var d,f={order:["zspace","yspace","xspace"],xspace:{},yspace:{},zspace:{}},g=new DataView(a,0,348),h=new Uint8Array(a,0,348),i=!0,j=g.getUint32(0,!0);348===j?i=!0:1543569408===j?i=!1:d="This does not look like a NIfTI-1 file.";var k=g.getUint16(40,i);(3>k||k>4)&&(d="Cannot handle "+k+"-dimensional images yet.");var l=String.fromCharCode.apply(null,h.subarray(344,348));if("n+1\x00"!==l&&(d="Bad magic number: '"+l+"'"),void 0!==d)throw BrainBrowser.events.triggerEvent("error",{message:d}),new Error(d);f.xspace.space_length=g.getUint16(42,i),f.yspace.space_length=g.getUint16(44,i),f.zspace.space_length=g.getUint16(46,i);var m=g.getUint16(48,i),n=g.getUint16(70,i),o=g.getUint16(72,i),p=g.getFloat32(80,i),q=g.getFloat32(84,i),r=g.getFloat32(88,i),s=g.getFloat32(92,i),t=g.getFloat32(108,i);352>t&&(t=352);var u=g.getFloat32(112,i),v=g.getFloat32(116,i),w=g.getUint16(252,i),x=g.getUint16(254,i),y=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];if(m>=1&&(f.time={},f.time.space_length=m,f.time.step=s,f.time.start=0,f.time.name="time",f.order=["time","zspace","yspace","xspace"]),f.bytes_per_voxel=o/8,f.must_swap_data=!i&&f.bytes_per_voxel>1,x>0)y[0][0]=g.getFloat32(280,i),y[0][1]=g.getFloat32(284,i),y[0][2]=g.getFloat32(288,i),y[0][3]=g.getFloat32(292,i),y[1][0]=g.getFloat32(296,i),y[1][1]=g.getFloat32(300,i),y[1][2]=g.getFloat32(304,i),y[1][3]=g.getFloat32(308,i),y[2][0]=g.getFloat32(312,i),y[2][1]=g.getFloat32(316,i),y[2][2]=g.getFloat32(320,i),y[2][3]=g.getFloat32(324,i);else if(w>0){var z=g.getFloat32(256,i),A=g.getFloat32(260,i),B=g.getFloat32(264,i),C=g.getFloat32(268,i),D=g.getFloat32(272,i),E=g.getFloat32(276,i),F=g.getFloat32(76,i)<0?-1:1;y=b(z,A,B,C,D,E,p,q,r,F)}else y[0][0]=p,y[1][1]=q,y[2][2]=r;e.utils.transformToMinc(y,f),f.datatype=n,f.vox_offset=t,f.scl_slope=u,f.scl_inter=v,BrainBrowser.utils.isFunction(c)&&c(f)}function b(a,b,c,d,e,f,g,h,i,j){var k,l,m,n,o=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,1]],p=a,q=b,r=c;return k=1-(p*p+q*q+r*r),1e-7>k?(k=1/Math.sqrt(p*p+q*q+r*r),p*=k,q*=k,r*=k,k=0):k=Math.sqrt(k),l=g>0?g:1,m=h>0?h:1,n=i>0?i:1,0>j&&(n=-n),o[0][0]=(k*k+p*p-q*q-r*r)*l,o[0][1]=2*(p*q-k*r)*m,o[0][2]=2*(p*r+k*q)*n,o[1][0]=2*(p*q+k*r)*l,o[1][1]=(k*k+q*q-p*p-r*r)*m,o[1][2]=2*(q*r-k*p)*n,o[2][0]=2*(p*r-k*q)*l,o[2][1]=2*(q*r+k*p)*m,o[2][2]=(k*k+r*r-q*q-p*p)*n,o[0][3]=d,o[1][3]=e,o[2][3]=f,o}function c(a,b,c){var f=e.createVolume(a,d(a,b));f.type="nifti",f.intensity_min=f.header.voxel_min,f.intensity_max=f.header.voxel_max,f.saveOriginAndTransform(a),BrainBrowser.utils.isFunction(c)&&c(f)}function d(a,b){var c=null;switch(a.must_swap_data&&e.utils.swapn(new Uint8Array(b,a.vox_offset),a.bytes_per_voxel),a.datatype){case 2:c=new Uint8Array(b,a.vox_offset);break;case 4:c=new Int16Array(b,a.vox_offset);break;case 8:c=new Int32Array(b,a.vox_offset);break;case 16:c=new Float32Array(b,a.vox_offset);break;case 64:c=new Float64Array(b,a.vox_offset);break;case 256:c=new Int8Array(b,a.vox_offset);break;case 512:c=new Uint16Array(b,a.vox_offset);break;case 768:c=new Uint32Array(b,a.vox_offset);break;default:var d="Unsupported data type: "+a.datatype;throw BrainBrowser.events.triggerEvent("error",{message:d}),new Error(d)}var f=0,g=a.scl_slope,h=a.scl_inter;if(0!==g){var i=new Float32Array(c.length);for(f=0;f<c.length;f++)i[f]=c[f]*g+h;c=i}return e.utils.scanDataRange(c,a),4===a.order.length&&(a.order=a.order.slice(1)),a[a.order[0]].offset=a[a.order[1]].space_length*a[a.order[2]].space_length,a[a.order[1]].offset=a[a.order[2]].space_length,a[a.order[2]].offset=1,a.time&&(a.time.offset=a.xspace.space_length*a.yspace.space_length*a.zspace.space_length),c}var e=BrainBrowser.VolumeViewer;e.volume_loaders.nifti1=function(b,d){var e;if(b.nii_url)BrainBrowser.loader.loadFromURL(b.nii_url,function(b){a(b,function(a){c(a,b,d)})},{result_type:"arraybuffer"});else{if(!b.nii_file)throw e="invalid volume description.\nDescription must contain the property 'nii_url' or 'nii_file'.",BrainBrowser.events.triggerEvent("error",{message:e}),new Error(e);BrainBrowser.loader.loadFromFile(b.nii_file,function(b){a(b,function(a){c(a,b,d)})},{result_type:"arraybuffer"})}},e.utils.transformToMinc=function(a,b){function c(a){var b=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];return 0>=b&&(b=1),Math.sqrt(b)}function d(a,b,c){return a[0]*(b[1]*c[2]-b[2]*c[1])-a[1]*(b[0]*c[2]-b[2]*c[0])+a[2]*(b[0]*c[1]-b[1]*c[0])}for(var e=[],f=[],g=[],h=c(a[0]),i=c(a[1]),j=c(a[2]),k=a[0][0]<0?-h:h,l=a[1][1]<0?-i:i,m=a[2][2]<0?-j:j,n=0;3>n;n++)e[n]=a[n][0]/k,f[n]=a[n][1]/l,g[n]=a[n][2]/m;b.xspace.step=k,b.yspace.step=l,b.zspace.step=m;var o=[a[0][3],a[1][3],a[2][3]],p=d(e,f,g),q=d(o,f,g),r=d(e,o,g),s=d(e,f,o);b.xspace.start=q/p,b.yspace.start=r/p,b.zspace.start=s/p,b.xspace.direction_cosines=e,b.yspace.direction_cosines=f,b.zspace.direction_cosines=g},e.utils.swapn=function(a,b){for(var c=0;c<a.length;c+=b)for(var d=b-1,e=0;d>e;){var f=a[c+d];a[c+d]=a[c+e],a[c+e]=f,d--,e++}}}(),function(){"use strict";function a(a,b,c,d){var e=a.length;if(1===e)return a[0];var f,g,h,i,j,k,l,m,n,o=c.data,p=c.width,q=c.height,r=new Uint32Array(a.length),s=new Float32Array(b);for(f=0;q>f;f+=1)for(n=f*p,g=0;p>g;g+=1)for(k=4*(n+g),l=0,h=0;e>h;h+=1)if(i=a[h],f<i.height&&g<i.width){if(j=i.data,m=r[h],o[k]=o[k]*l+j[m]*s[h],o[k+1]=o[k+1]*l+j[m+1]*s[h],o[k+2]=o[k+2]*l+j[m+2]*s[h],d){var t=j[m+3]/255*s[h];o[k]=o[k]*(1-t)+j[m]*t,o[k+1]=o[k+1]*(1-t)+j[m+1]*t,o[k+2]=o[k+2]*(1-t)+j[m+2]*t}o[k+3]=255,l=s[h],r[h]+=4}return c}var b=BrainBrowser.VolumeViewer,c=document.createElement("canvas").getContext("2d");b.volume_loaders.overlay=function(d,e){d=d||{};var f=d.volumes||[],g={type:"overlay",position:{},position_continuous:{},header:f[0]?f[0].header:{},intensity_min:0,intensity_max:255,volumes:[],blend_ratios:[],mask_overlay:!1,slice:function(a,b,c){b=void 0===b?this.position[a]:b,c=void 0===c?this.current_time:c;var d=this,e=[];return d.volumes.forEach(function(d){var f=d.slice(a,b,c);e.push(f)}),{height_space:e[0].height_space,width_space:e[0].width_space,slices:e}},getSliceImage:function(d,e,f,h){e=e||1;var i=d.slices,j=[],k=0,l=0;return i.forEach(function(a,d){var i,m=g.volumes[d],n=m.color_map,o=m.intensity_min,p=m.intensity_max;if(!n)throw i="No color map set for this volume. Cannot render slice.",g.triggerEvent("error",{message:i}),new Error(i);var q=a.width_space.step,r=a.height_space.step,s=Math.abs(Math.floor(a.width*q*e)),t=Math.abs(Math.floor(a.height*r*e)),u=c.createImageData(a.width,a.height),v=c.createImageData(s,t);n.mapColors(a.data,{min:o,max:p,contrast:f,brightness:h,destination:u.data}),v.data.set(b.utils.nearestNeighbor(u.data,u.width,u.height,s,t,{block_size:4})),k=Math.max(k,s),l=Math.max(l,t),j.push(v)}),a(j,g.blend_ratios,c.createImageData(k,l),g.mask_overlay)},getIntensityValue:function(a,b,c,d){a=void 0===a?this.position.xspace:a,b=void 0===b?this.position.yspace:b,c=void 0===c?this.position.zspace:c,d=void 0===d?this.current_time:d;var e=this,f=[];return e.volumes.forEach(function(e){var g=e.header;(0>a||a>g.xspace.space_length||0>b||b>g.yspace.space_length||0>c||c>g.zspace.space_length)&&f.push(0);var h,i,j=e.slice("zspace",c,d),k=j.data;"xspace"===j.width_space.name?(h=a,i=b):(h=b,i=c),f.push(k[(j.height_space.space_length-i-1)*j.width+h])}),f.reduce(function(a,b,c){return a+b*e.blend_ratios[c]},0)},setMaskOverlay:function(a){g.mask_overlay=a}};f.forEach(function(a){g.volumes.push(a),g.blend_ratios.push(1/f.length)}),BrainBrowser.utils.isFunction(e)&&e(g)}}(),function(){"use strict";var a=BrainBrowser.VolumeViewer;a.volume_loaders.overlayVolumes=function(a,b){a=a||{};var c=a.volumes||[],d={type:"overlay",position:{},position_continuous:{},header:{},intensity_min:0,intensity_max:255,volumes:[],blend_ratios:[],mask_overlay:!1,slice:function(a,b,c){b=void 0===b?this.position[a]:b,c=void 0===c?this.current_time:c;var d=this,e=function(a,b){var e=this.slice_num;return d.volumes[a].slice(b,e,c)}.bind({slice_num:b});return{height_space:this.header[a].height_space,width_space:this.header[a].width_space,slice:e}},getSliceImage:function(a,b,c,d){return this.volumes[a].getSliceImage(b,1,c,d)},getIntensityValue:function(a,b,c){a=void 0===a?this.position.xspace:a,b=void 0===b?this.position.yspace:b,c=void 0===c?this.position.zspace:c;var d=this,e=[];return d.volumes.forEach(function(d){e.push(d.getIntensityValue(a,b,c))}),e.reduce(function(a,b,c){return a+b*d.blend_ratios[c]},0)},setMaskOverlay:function(a){d.mask_overlay=a}};c.forEach(function(a){d.volumes.push(a),d.blend_ratios.push(1/c.length)});var e={position:{},position_continuous:{},xspace:{name:"xspace",space_length:Number.MIN_VALUE,step:Number.MAX_VALUE,start:Number.MAX_VALUE},yspace:{name:"yspace",space_length:Number.MIN_VALUE,step:Number.MAX_VALUE,start:Number.MAX_VALUE},zspace:{name:"zspace",space_length:Number.MIN_VALUE,step:Number.MAX_VALUE,start:Number.MAX_VALUE},order:["xspace","yspace","zspace"]};c.forEach(function(a){e.order.forEach(function(b){e[b].space_length=Math.max(e[b].space_length,a.header[b].space_length),e[b].step=Math.min(e[b].step,a.header[b].step),e[b].start=Math.min(e[b].start,a.header[b].start)})}),e.voxel_origin={x:e.xspace.start,y:e.yspace.start,z:e.zspace.start},e.xspace.width_space=e.yspace,e.xspace.width=e.yspace.space_length,e.xspace.height_space=e.zspace,e.xspace.height=e.zspace.space_length,e.yspace.width_space=e.xspace,e.yspace.width=e.xspace.space_length,e.yspace.height_space=e.zspace,e.yspace.height=e.zspace.space_length,e.zspace.width_space=e.xspace,e.zspace.width=e.xspace.space_length,e.zspace.height_space=e.yspace,e.zspace.height=e.yspace.space_length,e.order.forEach(function(a){var b=e[a].space_length/2;d.position[a]=Math.floor(b),d.position_continuous[a]=b}),d.header=e,BrainBrowser.utils.isFunction(b)&&b(d)}}();